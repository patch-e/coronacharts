<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    
    <title>PA Counties of Interest - Total COVID-19 Cases By Date</title>
    
    <script 
        src="https://code.jquery.com/jquery-3.4.1.min.js"
        integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.3/Chart.min.js"></script>
    
    <link
        rel="stylesheet"
        href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
        integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T"
        crossorigin="anonymous">
    <style>
        body { padding: 10px 0; }
        h1 {
            font-size: 1.5rem;
            margin-bottom: 20px;
            text-align: center;
        }
    </style>
</head>

<body>
    <div class="container-fluid">
        <h1>PA Counties of Interest - Total COVID-19 Cases By Date (updates daily)</h1>
        <canvas id="canvas"></canvas>
        <hr>
        <p>
            Data courtesy of the PA Department of Health 
            <a href="https://www.health.pa.gov/topics/disease/coronavirus/Pages/Cases.aspx" target="_blank">COVID-19 Cases in Pennsylvania</a>
            resource. The PA Department of Health updates the county statistics around 12pm EST everyday.<br><mark>This page will automatically update
            around 1pm EST</mark>.
        </p>
        <ul>
            <li>Colors representing counties are randomized on page load.</li>
            <li>Tap county labels in the top legend to toggle their display.</li>
            <li>Page displays best in landscape orientation on phone devices.</li>
        </ul>
        <p>
            <button
                class="btn btn-secondary btn-sm"
                type="button"
                data-toggle="collapse"
                data-target="#rawData"
                aria-expanded="false"
                aria-controls="rawData">
              View raw data
            </button>
        </p>
        <div class="collapse" id="rawData">
            <div class="card bg-light">
                <div class="card-header">Raw Data</div>
                <div class="card-body">
                    <pre id="rawDataContainer"></pre>
                </div>
            </div>
        </div>
        <hr>
        <p>
            <small>
                Created by <a href="https://mccrager.com" target="_blank">Patrick Crager</a>.
                Open source on <a href="https://github.com/patch-e/coronacharts" target="_blank">github</a>.
            </small>
        </p>
    </div>

	<script>
        $(function() {
            const devMode = false;
            const url = devMode ? 'http://localhost:4000/nodejs/corona' : '/nodejs/corona'

            $.get(url, function(data) {
                const parsedData = parseData(data);
                const config = createConfig(parsedData.labels, parsedData.datasets);

                activateChart(config);
            });
        });

        function parseData(data) {
            document.getElementById('rawDataContainer').innerText = JSON.stringify(data, null, 2);

            const dateLabels = [... new Set(data.map(data => data.date))];
            const countyData = [... new Set(data.map(data => data.name))];
            
            var countyCases = [];
            for (const county of countyData) {
                var result = data.filter(obj => {
                    return obj.name === county;
                });
                
                var color = getRandomColor();
                
                var dataset = {};
                dataset.backgroundColor = color;
                dataset.borderColor = color;
                dataset.fill = false;
                dataset.label = county;
                dataset.lineTension = 0;
                var cases = [];
                for (i = 0; i < result.length; i++) {
                    cases.push(result[i].cases);
                }
                dataset.data = cases;
                
                countyCases.push(dataset);
            };

            return { 
                datasets: countyCases,
                labels: dateLabels
            };
        };

        function createConfig(labels, datasets) {
            return {
			    type: 'line',
			    data: {
                    labels: labels,
                    datasets: datasets.reverse()
                },
                options: {
                    responsive: true,
                    tooltips: {
                        mode: 'index',
                        intersect: false,
                    },
                    hover: {
                        mode: 'nearest',
                        intersect: true
                    },
                    scales: {
                        xAxes: [{
                            display: true,
                            scaleLabel: {
                                display: true,
                                labelString: 'Date'
                            }
                        }],
                        yAxes: [{
                            display: true,
                            scaleLabel: {
                                display: true,
                                labelString: 'Total Cases'
                            }
                        }]
                    }
                }
            };
        };
        
        function activateChart(config) {
            const context = document.getElementById('canvas').getContext('2d');
			window.lineChart = new Chart(context, config);
        };

        function getRandomColor() {
            var letters = '0123456789ABCDEF'.split('');
            var color = '#';
            
            for (var i = 0; i < 6; i++ ) {
                color += letters[Math.floor(Math.random() * 16)];
            }
            
            return color;
        };
    </script>
    
    <script
        src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
        integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
        crossorigin="anonymous"></script>

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-30089053-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-30089053-1');
    </script>
</body>

</html>
